<?php
    $hostname = "db";
    $username = "admin";
    $password = "test";
    $db = "database";
    
    $conn = mysqli_connect($hostname, $username, $password, $db);
    if ($conn->connect_error) {
        die("Database connection failed: " . $conn->connect_error);
    }
    
    // Initialize error messages
    $errorUsername = $errorNombre = $errorDni = $errorTelf = $errorPassword = "";
    
    // Check if the form is submitted
    if (isset($_POST['submit'])) {
        // Get user input from the form
        $username = $_POST['username'];
        $nombre_apellidos = $_POST['nombre_apellidos'];
        $dni = $_POST['dni'];
        $telf = $_POST['telf'];
        $fecha_nacimiento = $_POST['fecha_nacimiento'];
        $email = $_POST['email'];
        $password = $_POST['password'];
        $password2 = $_POST['password2'];

        // Check if the username is already registered
        $check_username_query = "SELECT * FROM usuarios WHERE username = '$username'";
        $check_username_result = mysqli_query($conn, $check_username_query);

        if (mysqli_num_rows($check_username_result) > 0) {
            $errorUsername = "Username already exists.";
        } elseif (!preg_match('/^\d{9}$/', $telf)) {
            $errorTelf = "Invalid telephone number format. Please enter a 9-digit number.";
        } elseif ($password != $password2) {
            $errorPassword = "Passwords do not match. Please confirm your password.";
        } else {
            // Insert the user data into the database
            $query = "INSERT INTO usuarios (username, nombre_apellidos, dni, telf, fecha_nacimiento, email, password)
                    VALUES ('$username', '$nombre_apellidos', '$dni', '$telf', '$fecha_nacimiento', '$email', '$password')";
            $result = mysqli_query($conn, $query);

            if ($result) {
                // Registration successful, redirect to the login page
                header("Location: login.php");
                exit;
            } else {
                echo "Error adding user: " . mysqli_error($conn);
            }
        }
    }
?>